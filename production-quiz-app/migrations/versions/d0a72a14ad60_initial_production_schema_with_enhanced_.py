"""Initial production schema with enhanced User model and constraints

Revision ID: d0a72a14ad60
Revises: 
Create Date: 2025-12-19 13:58:59.104151

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = 'd0a72a14ad60'
down_revision = None
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('quizzes',
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('category', sa.String(length=100), nullable=False),
    sa.Column('title', sa.String(length=200), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('icon', sa.String(length=10), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('time_limit_minutes', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('category'),
    sa.UniqueConstraint('category', name='uq_quiz_category')
    )
    with op.batch_alter_table('quizzes', schema=None) as batch_op:
        batch_op.create_index('idx_quiz_category', ['category'], unique=False)

    op.create_table('users',
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('username', sa.String(length=80), nullable=False),
    sa.Column('email', sa.String(length=120), nullable=False),
    sa.Column('password_hash', sa.String(length=255), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('is_admin', sa.Boolean(), nullable=False),
    sa.Column('email_verified', sa.Boolean(), nullable=False),
    sa.Column('verification_token', sa.String(length=100), nullable=True),
    sa.Column('password_reset_token', sa.String(length=100), nullable=True),
    sa.Column('reset_token_expires', sa.DateTime(), nullable=True),
    sa.Column('failed_login_attempts', sa.Integer(), nullable=False),
    sa.Column('account_locked_until', sa.DateTime(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('last_active', sa.DateTime(), nullable=False),
    sa.CheckConstraint('failed_login_attempts >= 0', name='check_failed_attempts_positive'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('password_reset_token'),
    sa.UniqueConstraint('username'),
    sa.UniqueConstraint('verification_token')
    )
    with op.batch_alter_table('users', schema=None) as batch_op:
        batch_op.create_index('idx_user_email', ['email'], unique=False)
        batch_op.create_index('idx_user_last_active', ['last_active'], unique=False)
        batch_op.create_index('idx_user_username', ['username'], unique=False)
        batch_op.create_index(batch_op.f('ix_users_email'), ['email'], unique=True)

    op.create_table('attempts',
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('quiz_id', sa.Integer(), nullable=False),
    sa.Column('started_at', sa.DateTime(), nullable=False),
    sa.Column('completed_at', sa.DateTime(), nullable=True),
    sa.Column('time_taken', sa.Integer(), nullable=True),
    sa.Column('score', sa.Integer(), nullable=True),
    sa.Column('total_questions', sa.Integer(), nullable=True),
    sa.Column('percentage', sa.Float(), nullable=True),
    sa.CheckConstraint('percentage IS NULL OR (percentage >= 0 AND percentage <= 100)', name='check_percentage_valid'),
    sa.CheckConstraint('score IS NULL OR (score >= 0 AND score <= total_questions)', name='check_score_valid'),
    sa.CheckConstraint('time_taken IS NULL OR time_taken >= 0', name='check_time_taken_positive'),
    sa.ForeignKeyConstraint(['quiz_id'], ['quizzes.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('attempts', schema=None) as batch_op:
        batch_op.create_index('idx_attempt_completed_at', ['completed_at'], unique=False)
        batch_op.create_index('idx_attempt_user_quiz', ['user_id', 'quiz_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_attempts_completed_at'), ['completed_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_attempts_quiz_id'), ['quiz_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_attempts_user_id'), ['user_id'], unique=False)

    op.create_table('questions',
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('quiz_id', sa.Integer(), nullable=False),
    sa.Column('question_text', sa.Text(), nullable=False),
    sa.Column('option_1', sa.String(length=500), nullable=False),
    sa.Column('option_2', sa.String(length=500), nullable=False),
    sa.Column('option_3', sa.String(length=500), nullable=False),
    sa.Column('option_4', sa.String(length=500), nullable=False),
    sa.Column('correct_answer', sa.Integer(), nullable=False),
    sa.Column('explanation', sa.Text(), nullable=False),
    sa.Column('difficulty', sa.String(length=20), nullable=False),
    sa.Column('order_index', sa.Integer(), nullable=True),
    sa.CheckConstraint("difficulty IN ('easy', 'medium', 'hard')", name='check_difficulty_enum'),
    sa.CheckConstraint('correct_answer >= 0 AND correct_answer <= 3', name='check_correct_answer_range'),
    sa.ForeignKeyConstraint(['quiz_id'], ['quizzes.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('questions', schema=None) as batch_op:
        batch_op.create_index('idx_question_difficulty', ['difficulty'], unique=False)
        batch_op.create_index('idx_question_quiz_difficulty', ['quiz_id', 'difficulty'], unique=False)
        batch_op.create_index('idx_question_quiz_id', ['quiz_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_questions_quiz_id'), ['quiz_id'], unique=False)

    op.create_table('user_answers',
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('attempt_id', sa.Integer(), nullable=False),
    sa.Column('question_id', sa.Integer(), nullable=False),
    sa.Column('selected_answer', sa.Integer(), nullable=True),
    sa.Column('is_correct', sa.Boolean(), nullable=False),
    sa.Column('answered_at', sa.DateTime(), nullable=False),
    sa.CheckConstraint('selected_answer IS NULL OR (selected_answer >= 0 AND selected_answer <= 3)', name='check_selected_answer_range'),
    sa.ForeignKeyConstraint(['attempt_id'], ['attempts.id'], ),
    sa.ForeignKeyConstraint(['question_id'], ['questions.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('attempt_id', 'question_id', name='uq_attempt_question')
    )
    with op.batch_alter_table('user_answers', schema=None) as batch_op:
        batch_op.create_index('idx_user_answer_attempt_id', ['attempt_id'], unique=False)
        batch_op.create_index('idx_user_answer_question_id', ['question_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_user_answers_attempt_id'), ['attempt_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_user_answers_question_id'), ['question_id'], unique=False)

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('user_answers', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_user_answers_question_id'))
        batch_op.drop_index(batch_op.f('ix_user_answers_attempt_id'))
        batch_op.drop_index('idx_user_answer_question_id')
        batch_op.drop_index('idx_user_answer_attempt_id')

    op.drop_table('user_answers')
    with op.batch_alter_table('questions', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_questions_quiz_id'))
        batch_op.drop_index('idx_question_quiz_id')
        batch_op.drop_index('idx_question_quiz_difficulty')
        batch_op.drop_index('idx_question_difficulty')

    op.drop_table('questions')
    with op.batch_alter_table('attempts', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_attempts_user_id'))
        batch_op.drop_index(batch_op.f('ix_attempts_quiz_id'))
        batch_op.drop_index(batch_op.f('ix_attempts_completed_at'))
        batch_op.drop_index('idx_attempt_user_quiz')
        batch_op.drop_index('idx_attempt_completed_at')

    op.drop_table('attempts')
    with op.batch_alter_table('users', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_users_email'))
        batch_op.drop_index('idx_user_username')
        batch_op.drop_index('idx_user_last_active')
        batch_op.drop_index('idx_user_email')

    op.drop_table('users')
    with op.batch_alter_table('quizzes', schema=None) as batch_op:
        batch_op.drop_index('idx_quiz_category')

    op.drop_table('quizzes')
    # ### end Alembic commands ###
